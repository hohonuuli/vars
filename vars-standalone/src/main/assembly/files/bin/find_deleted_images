#!/usr/bin/env bash

# Create Log directory
LOGHOME=$HOME/Library/Logs 
mkdir -p $LOGHOME

# FG is Framegrab root
FG=/mbari/framegrabs

# SFG is the week old framegrab root
SNAPSHOTS=/mbari/framegrabs/.snapshot
WEEK_OLD=$(ls $SNAPSHOTS | tail -7 | head -1)
SFG=${SNAPSHOTS}/${WEEK_OLD}

# Loop over directories, ignore sym links
for FDIR in ${FG}/*
do
  
  if [ -h "$FDIR" ]; then
    # do NOTHING. It's a symbolic link
    echo "Not searching $FDIR"
  else
    CURRENT_SRC="$FDIR"
    PLATFORM=$(basename "$FDIR")
    OLD_SRC=${SFG}/$PLATFORM
    
    CURRENT_TARGET="$LOGHOME/current-framegrabs-$PLATFORM.txt"
    OLD_TARGET="$LOGHOME/weekold-framegrabs-$PLATFORM.txt"
    DIFF_TARGET="$LOGHOME/diff-framegrabs-$PLATFORM.txt"
    
    echo "Creating and Comparing $CURRENT_TARGET and $OLD_TARGET"
    
    find "$CURRENT_SRC" -name "*.png" > "$CURRENT_TARGET"
    find "$OLD_SRC" -name "*.png" > "$OLD_TARGET"

    diff "$OLD_TARGET" "$CURRENT_TARGET" | grep "^<." | sed s/"< "// > "$DIFF_TARGET"
    echo "This is a listing of images that were deleted from $CURRENT_SRC in the past week. Please verify that they were intentinally removed. If they were not, you can retrieve an archived copy from ${OLD_SRC}." | mail -s "Framegrab deletion report for ${FDIR}" -a $DIFF_TARGET videolabadmin@mbari.org brian@mbari.org
    
    echo "Done examining $CURRENT_SRC and $OLD_SRC"
  fi
done
